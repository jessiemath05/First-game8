<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">

    <!-- âœ… å¿«å–é€£çµé è¦½ï¼ˆè«‹æ”¾åœ¨ <head> è£¡ï¼‰ -->
    <meta name="description" content="Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.">
    <!-- âœ… LINE / FB é è¦½ç”¨ -->
    <meta property="og:title" content="Jessie Math - é¢ç©å¤§æŒ‘æˆ°">
    <meta property="og:description" content="Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.">
    <meta property="og:type" content="website">

    <!-- âœ… é è¦½åœ–ç‰‡ï¼ˆæœ¬éŠæˆ²ï¼šäº”å¹´ç´šä¸»é¡Œå…« â†’ g5-u8.pngï¼‰ -->
    <meta property="og:image" content="g5-u8.png">
    <meta property="og:image:width" content="1024">
    <meta property="og:image:height" content="1536">
    <meta property="og:image:alt" content="Jessie Math éŠæˆ²å°é¢">

    <!-- âœ… æœ‰äº›å¹³å°æœƒåƒè€ƒ -->
    <link rel="image_src" href="g5-u8.png">

    <!-- âœ… Twitter / Xï¼ˆå¯ç”¨åŒä¸€å¼µåœ–ï¼‰ -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Jessie Math - é¢ç©å¤§æŒ‘æˆ°">
    <meta name="twitter:description" content="Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.">
    <meta name="twitter:image" content="g5-u8.png">

    <!-- âœ… RWDï¼ˆæ‰‹æ©Ÿ / å¹³æ¿ / é›»è…¦ï¼‰ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Jessie Math - é¢ç©å¤§æŒ‘æˆ°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        /* == CSS æ¨£å¼å€åŸŸ - æœ€çµ‚ç©©å®šç‰ˆæ¨£å¼èˆ‡éŸ¿æ‡‰å¼è¨­è¨ˆ == */
        :root {
            --primary-color: #FFC300; /* é»ƒè‰² */
            --secondary-color: #333;
            --text-color: #000;
            --background-color: #f4f4f4;
            --success-color: #28a745;
            --error-color: #dc3545;
            --info-color: #17a2b8;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            box-sizing: border-box;
        }

        /* å°èˆªåˆ— (Navbar) */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 5%;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .logo-area {
            display: flex;
            align-items: center;
        }
        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .navbar h1 {
            font-size: 1.5em;
            color: var(--secondary-color);
            margin: 0;
        }
        .nav-links {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }
        .nav-button {
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 20px;
            background-color: #eee;
            color: var(--secondary-color);
            white-space: nowrap;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            transition: all 0.3s;
        }
        .nav-button i { margin-right: 5px; }
        .primary-button {
            background-color: var(--primary-color);
            border: 2px solid var(--primary-color);
            font-weight: bold;
        }

        /* éŠæˆ²ä¸»å®¹å™¨ */
        #game-container {
            max-width: 900px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* å•Ÿå‹•é é¢ (Start Modal) */
        #start-modal {
            margin: 50px auto;
            width: 100%;
        }
        .modal-content {
            background-color: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            margin: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            text-align: center;
        }
        #player-name-input {
            padding: 12px; width: 100%; box-sizing: border-box; border: 2px solid #ddd;
            border-radius: 8px; font-size: 1.3em; margin: 10px 0 20px 0;
        }
        .action-button {
            padding: 12px 25px; margin-top: 25px; background-color: var(--primary-color);
            border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em;
            font-weight: bold; width: 100%;
        }
        .game-rules { margin-top: 20px; }

        /* éŠæˆ²ä»‹é¢ (Question Panel) */
        .hidden { display: none !important; }

        .status-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background-color: #333;
            color: white;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }
        .game-question-panel {
            border: 1px solid #ccc; padding: 20px; min-height: 400px;
            border-radius: 5px; background-color: #fff; text-align: center;
            display: flex; flex-direction: column; align-items: center;
        }
        #context-image {
            width: 100%;
            max-width: 450px;
            height: 220px;
            background-color: #ffffff;
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* SVG æ¨£å¼ä¿®æ­£ */
        .shape {
            fill: #ADD8E6;
            stroke: #000;
            stroke-width: 2;
        }
        .height-line { stroke: #ff0000; stroke-width: 1.5; stroke-dasharray: 4; }
        .label { font-family: Arial, sans-serif; font-size: 14px; fill: var(--secondary-color); font-weight: bold; }

        .question-text {
            font-size: 1.5em;
            margin-bottom: 25px;
            font-weight: bold;
        }
        .answer-area {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 450px;
            margin-bottom: 20px;
        }
        .answer-area input {
            padding: 15px; font-size: 1.5em; border: 2px solid #ddd;
            border-radius: 5px; width: 180px; text-align: center; margin-right: 20px;
        }
        .submit-btn { padding: 15px 30px; font-size: 1.2em; }

        .control-buttons {
            display: flex; justify-content: space-between; gap: 20px;
            margin-top: auto; padding-top: 20px; width: 100%; max-width: 500px;
        }
        .control-btn {
            padding: 12px 18px; border: none; border-radius: 5px; cursor: pointer;
            background-color: #e0e0e0; font-size: 1.05em; flex-grow: 1; min-width: 100px; font-weight: bold;
        }
        .feedback.correct { color: var(--success-color); font-weight: bold; }
        .feedback.incorrect { color: var(--error-color); font-weight: bold; }

        /* -------------------------------------- */
        /* 1. é›£åº¦æŒ‰éˆ•æ¨£å¼ä¿®æ­£ */
        /* -------------------------------------- */
        .difficulty-options {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            gap: 10px;
            justify-content: center; /* åœ¨å¤§è¢å¹•ä¸Šå±…ä¸­ */
        }
        .difficulty-options span {
            font-size: 1.1em;
            font-weight: bold;
            color: #555;
            white-space: nowrap;
        }
        .difficulty-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            background-color: #fff;
            cursor: pointer;
            border-radius: 8px; /* æ–¹ä¸­å¸¶åœ“ */
            font-size: 1.05em;
            transition: all 0.3s;
            flex-grow: 1;
            max-width: 120px;
            font-weight: bold;
        }
        .difficulty-btn.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(255, 195, 0, 0.4);
            color: var(--secondary-color);
        }
        .difficulty-btn:hover {
            border-color: var(--primary-color);
        }
        /* -------------------------------------- */

        /* é—œå¡é¸æ“‡å€ä½ˆå±€ */
        .level-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin-top: 20px;
        }
        @media (min-width: 600px) {
            .level-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        .level-card {
            padding: 30px 20px; border-radius: 10px; border: 2px solid #ddd;
            text-align: center; min-height: 150px;
            display: flex; flex-direction: column; justify-content: center;
            background-color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .level-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .level-card h3 { font-size: 1.8em; margin: 0 0 8px 0; }
        .level-card p { font-size: 1.3em; margin: 0 0 10px 0; font-weight: 500; }
        .stars { color: gold; font-size: 1.5em; margin-top: 5px; }

        /* -------------------------------------- */
        /* 2. æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼è¨­è¨ˆ (RWD å¼·åŒ–) */
        /* -------------------------------------- */
        @media (max-width: 768px) {
            /* å°èˆªåˆ—å †ç–Š */
            .navbar {
                flex-direction: column;
                align-items: center;
                padding: 10px 3%;
                gap: 10px;
            }
            .logo-area {
                width: 100%;
                justify-content: center;
                margin-bottom: 5px;
            }
            .nav-links {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap; /* å…è¨±æŒ‰éˆ•æ›è¡Œ */
                justify-content: space-around;
                margin-left: 0;
            }
            .nav-button {
                padding: 6px 10px;
                font-size: 0.85em;
                flex-grow: 1;
                margin: 2px; /* å¢åŠ å¾®å°é–“è· */
            }

            /* éŠæˆ²å®¹å™¨ */
            #game-container {
                padding: 0 10px;
            }

            /* é›£åº¦æŒ‰éˆ•åœ¨æ‰‹æ©Ÿä¸Šå¹³å‡åˆ†é…ç©ºé–“ */
            .difficulty-btn {
                flex-grow: 1;
                max-width: none;
            }
            .difficulty-options {
                justify-content: space-between;
                gap: 5px;
            }

            /* éŠæˆ²ç‹€æ…‹æ¬„ */
            .status-bar {
                font-size: 1em;
                justify-content: space-between;
            }

            /* éŠæˆ²é¢æ¿ - ç¢ºä¿è¼¸å…¥å’ŒæŒ‰éˆ•èƒ½ç”¨ */
            .game-question-panel {
                min-height: 350px;
                padding: 15px;
            }
            .question-text {
                font-size: 1.25em;
                margin-bottom: 15px;
            }
            .answer-area {
                max-width: 100%;
                margin-bottom: 15px;
            }
            .answer-area input {
                flex-grow: 1;
                width: auto;
                padding: 12px;
                font-size: 1.3em;
                margin-right: 10px;
            }
            .submit-btn {
                padding: 12px 20px;
                font-size: 1.1em;
            }

            /* æ§åˆ¶æŒ‰éˆ• - ç¢ºä¿åœ¨æ‰‹æ©Ÿåº•éƒ¨å¯æ“ä½œ */
            .control-buttons {
                gap: 5px;
                flex-wrap: wrap;
                max-width: 100%;
                padding-top: 15px;
            }
            .control-btn {
                padding: 10px 10px;
                font-size: 0.85em;
                min-width: 80px;
            }

            /* Footerï¼šæ‰‹æ©Ÿä¸Šæ›´èˆ’æœ */
            .footer-pill{
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .footer-right{
                width: 100%;
            }
        }

        /* -------------------------------------- */
        /* 3. Footerï¼ˆæ–°å¢ï¼‰ */
        /* -------------------------------------- */
        footer{
            max-width: 900px;
            margin: 18px auto 28px auto;
            padding: 0 20px;
            box-sizing: border-box;
        }
        .footer-pill{
            background: rgba(255,255,255,.9);
            border: 1px solid rgba(0,0,0,.08);
            box-shadow: 0 10px 30px rgba(0,0,0,.08);
            border-radius: 999px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 14px;
        }
        .footer-left{
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }
        .footer-dot{
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(255,195,0,.25);
            flex: 0 0 auto;
        }
        .footer-copy{
            font-size: 0.95em;
            color: #374151;
            font-weight: 700;
            white-space: nowrap;
        }
        .footer-right{
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }
        .footer-icon{
            width: 34px;
            height: 34px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,195,0,.18);
            border: 1px solid rgba(255,195,0,.35);
            color: #111827;
            flex: 0 0 auto;
        }
        .footer-tagline{
            font-size: 0.98em;
            color: #111827;
            font-weight: 800;
            white-space: nowrap;
        }
        @media (max-width: 420px){
            .footer-copy, .footer-tagline{ white-space: normal; line-height: 1.25; }
            .footer-pill{ border-radius: 18px; }
        }
    </style>
</head>
<body>

    <header class="navbar">
        <div class="logo-area">
            <img src="JESSIEMATH-Q.png" alt="Jessie Math Logo" class="profile-img">
            <h1>Jessie Math</h1>
        </div>
        <nav class="nav-links">
            <a href="https://jessiemath0703-chu.github.io/website2/" class="nav-button"><i class="fas fa-home"></i> é¦–é </a>
            <a href="https://jessiemath0703-chu.github.io/Game-Lobby/" class="nav-button"><i class="fas fa-gamepad"></i> éŠæˆ²å¤§å»³</a>
            <a href="https://jessiemath0703-chu.github.io/Game-Lobby/#g5-u8" class="nav-button primary-button"><i class="fas fa-arrow-left"></i> äº”å¹´ç´šé¢ç©</a>
        </nav>
    </header>

    <main id="game-container">

        <section id="start-modal" class="modal">
            <div class="modal-content">
                <h2>æ­¡è¿ä¾†åˆ°é¢ç©å¤§æŒ‘æˆ°ï¼</h2>
                <p style="margin-top: 15px; margin-bottom: 5px;">è«‹è¼¸å…¥æ‚¨çš„åå­—é–‹å§‹éŠæˆ²:</p>
                <input type="text" id="player-name-input" placeholder="æ‚¨çš„åå­—" maxlength="10">

                <div class="game-rules">
                    <h3>ğŸ“š éŠæˆ²è¦å‰‡èªªæ˜</h3>
                    <ul>
                        <li>è¨ˆæ™‚ï¼šæ¯å›åˆ **60 ç§’**ï¼Œç­”å° **+5 ç§’**ï¼Œç­”éŒ¯ **-5 ç§’**ã€‚</li>
                        <li>è¨ˆåˆ†ï¼šç­”å°å¾—åˆ†ï¼Œé€£çºŒç­”å°è§¸ç™¼ **Combo é€£æ“Š** (æœ€é«˜ 1.5 å€åˆ†)ã€‚</li>
                        <li>ç›®æ¨™ï¼šåœ¨æ™‚é–“å…§ç²å¾—é«˜åˆ†ï¼ŒæŒ‘æˆ° **ä¸‰é¡†æ˜Ÿ** è©•åƒ¹ï¼</li>
                    </ul>
                </div>
                <button id="start-game-button" class="action-button">ç¢ºèªä¸¦é¸æ“‡é—œå¡</button>
            </div>
        </section>

        <section id="level-selection" class="game-view hidden">
            <h2>ğŸ† é¸æ“‡é—œå¡èˆ‡é›£åº¦</h2>

            <div class="difficulty-options">
                <span>é›£åº¦/é€Ÿåº¦ï¼š</span>
                <button data-speed="easy" class="difficulty-btn active">ç°¡å–®</button>
                <button data-speed="medium" class="difficulty-btn">æ™®é€š</button>
                <button data-speed="hard" class="difficulty-btn">å›°é›£</button>
            </div>

            <div class="level-grid">
                <button data-level="1" class="level-card">
                    <h3>é—œå¡ 1</h3>
                    <p>ğŸ”· å¹³è¡Œå››é‚Šå½¢é¢ç©</p>
                    <div class="stars" data-stars="0">â˜†â˜†â˜†</div>
                </button>
                <button data-level="2" class="level-card">
                    <h3>é—œå¡ 2</h3>
                    <p>ğŸ”º ä¸‰è§’å½¢é¢ç©</p>
                    <div class="stars" data-stars="0">â˜†â˜†â˜†</div>
                </button>
                <button data-level="3" class="level-card">
                    <h3>é—œå¡ 3</h3>
                    <p>ğŸ”² æ¢¯å½¢é¢ç©</p>
                    <div class="stars" data-stars="0">â˜†â˜†â˜†</div>
                </button>
                <button data-level="4" class="level-card mixed-level">
                    <h3>é—œå¡ 4</h3>
                    <p>ğŸŒ€ è¤‡åˆå¼é¢ç© (æ··åˆ)</p>
                    <div class="stars" data-stars="0">â˜†â˜†â˜†</div>
                </button>
            </div>

            <button id="show-leaderboard-btn" class="action-button secondary-button"><i class="fas fa-list-ol"></i> æŸ¥çœ‹æ’è¡Œæ¦œ</button>
        </section>

        <section id="game-play-area" class="game-view hidden">
            <div class="status-bar">
                <div id="timer-display" class="timer">â³ 60s</div>
                <div id="score-display" class="score score-display">å¾—åˆ†: 0</div>
                <div id="combo-display" class="combo combo-display">é€£æ“Š: 0</div>
            </div>

            <div class="game-question-panel">
                <div id="context-image" class="context-image-placeholder">
                    è«‹é¸æ“‡é—œå¡é–‹å§‹éŠæˆ²ã€‚
                </div>

                <div id="question-text" class="question-text">
                    æº–å‚™å¥½äº†å—ï¼Ÿ
                </div>

                <div id="answer-area" class="answer-area">
                    <input type="number" id="answer-input" placeholder="å¡«å…¥ç­”æ¡ˆ (æ•´æ•¸)">
                    <button id="submit-answer-btn" class="action-button primary-button submit-btn">é€å‡ºç­”æ¡ˆ</button>
                </div>
                <div id="feedback-message" class="feedback"></div>

                <div class="control-buttons">
                    <button id="reset-button" class="control-btn"><i class="fas fa-redo"></i> é‡æ–°</button>
                    <button id="pause-button" class="control-btn"><i class="fas fa-pause"></i> æš«åœ</button>
                    <button id="exit-button" class="control-btn"><i class="fas fa-sign-out-alt"></i> å›é—œå¡ä¸»é¸å–®</button>
                </div>
            </div>
        </section>

        <div id="pause-overlay" class="modal hidden">
            <div class="modal-content pause-content">
                <h2>â¸ éŠæˆ²æš«åœä¸­</h2>
                <button id="resume-button" class="action-button">ç¹¼çºŒéŠæˆ²</button>
            </div>
        </div>

        <div id="result-modal" class="modal hidden">
            <div class="modal-content">
                <h2>ğŸ‰ æŒ‘æˆ°çµæŸï¼</h2>
                <p>ç©å®¶ï¼š<span id="final-player-name"></span></p>
                <p>æœ€çµ‚å¾—åˆ†ï¼š<span id="final-score"></span></p>
                <div id="final-stars" class="stars result-stars"></div>
                <p id="star-message"></p>

                <div id="correct-answer-display" class="correct-answer-info">
                    <h4>æœ¬å±€é¡Œç›®å›é¡§ï¼š</h4>
                </div>

                <button id="back-to-select" class="action-button">è¿”å›é—œå¡é¸æ“‡</button>
            </div>
        </div>

        <section id="leaderboard-view" class="game-view hidden">
            <h2>ğŸ¥‡ æ’è¡Œæ¦œ</h2>
            <ul id="leaderboard-list">
            </ul>
            <button id="back-from-leaderboard" class="action-button secondary-button">è¿”å›</button>
        </section>

    </main>

    <!-- âœ… Footerï¼ˆæ–°å¢ï¼‰ -->
    <footer>
        <div class="footer-pill">
            <div class="footer-left">
                <div class="footer-dot" aria-hidden="true"></div>
                <div class="footer-copy">Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.</div>
            </div>
            <div class="footer-right">
                <div class="footer-icon" aria-hidden="true"><i class="fas fa-compass"></i></div>
                <div class="footer-tagline">æ•¸å­¸ä¸è¿·è·¯ï¼ŒJessie å¸¶ä½ èµ°å‘ç†è§£ã€‚</div>
            </div>
        </div>
    </footer>

    <script>
        // å°‡æ‰€æœ‰é‚è¼¯åŒ…åœ¨ window.onload ç¢ºä¿ DOM è¼‰å…¥å®Œæˆï¼Œè§£æ±ºã€ŒéŠæˆ²é€²ä¸å»ã€çš„å•é¡Œ
        window.onload = function() {
            /* == JavaScript éŠæˆ²é‚è¼¯å€åŸŸ == */

            // == æ ¸å¿ƒè®Šæ•¸ ==
            let playerName = '';
            let currentLevel = 0;
            let currentScore = 0;
            let currentCombo = 0;
            let timeLeft = 60;
            let timerInterval = null;
            let isPaused = false;
            let questionHistory = [];

            // == DOM å…ƒç´  ==
            const startModal = document.getElementById('start-modal');
            const levelSelection = document.getElementById('level-selection');
            const gamePlayArea = document.getElementById('game-play-area');
            const pauseOverlay = document.getElementById('pause-overlay');
            const resultModal = document.getElementById('result-modal');
            const leaderboardView = document.getElementById('leaderboard-view');
            const contextImage = document.getElementById('context-image');

            const playerNameInput = document.getElementById('player-name-input');
            const timerDisplay = document.getElementById('timer-display');
            const scoreDisplay = document.getElementById('score-display');
            const comboDisplay = document.getElementById('combo-display');
            const questionText = document.getElementById('question-text');
            const answerInput = document.getElementById('answer-input');
            const submitButton = document.getElementById('submit-answer-btn');

            const STAR_THRESHOLD = { 1: 50, 2: 150, 3: 300 };

            // == è¼”åŠ©å‡½å¼ ==
            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            function getRandomEven(min, max) {
                let num = getRandomInt(min, max);
                return num % 2 === 0 ? num : num + 1;
            }

            // == å‡½å¼ï¼šä»‹é¢æ§åˆ¶ (ç¢ºä¿åˆ‡æ›é‚è¼¯ç„¡èª¤) ==
            const allViews = [startModal, levelSelection, gamePlayArea, resultModal, leaderboardView, pauseOverlay];
            function showView(viewElement) {
                allViews.forEach(el => {
                    if (el) el.classList.add('hidden');
                });
                if (viewElement) viewElement.classList.remove('hidden');
            }

            function startTimer() {
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    if (!isPaused) {
                        timeLeft--;
                        timerDisplay.textContent = `â³ ${timeLeft}s`;
                        if (timeLeft <= 0) {
                            endGame();
                        }
                    }
                }, 1000);
            }

            function togglePause() {
                if (gamePlayArea.classList.contains('hidden')) return;

                isPaused = !isPaused;
                if (isPaused) {
                    showView(pauseOverlay);
                    document.getElementById('pause-button').innerHTML = '<i class="fas fa-play"></i> ç¹¼çºŒ';
                } else {
                    showView(gamePlayArea);
                    document.getElementById('pause-button').innerHTML = '<i class="fas fa-pause"></i> æš«åœ';
                }
            }

            function startGame(level) {
                clearInterval(timerInterval);
                timeLeft = 60;
                currentScore = 0;
                currentCombo = 0;
                questionHistory = [];
                isPaused = false;

                timerDisplay.textContent = `â³ ${timeLeft}s`;
                scoreDisplay.textContent = `å¾—åˆ†: ${currentScore}`;
                comboDisplay.textContent = `é€£æ“Š: ${currentCombo}`;

                currentLevel = level;
                showView(gamePlayArea);
                startTimer();
                generateQuestion(level);
                answerInput.value = '';
                answerInput.focus();
            }

            // æ ¸å¿ƒå‡½å¼ï¼šç”Ÿæˆé¡Œç›®å’Œ SVG åœ–å½¢ (ç¢ºä¿ SVG é¡è‰²æ­£ç¢º)
            function generateQuestion(level) {
                let correctAns = 0;
                let questionHtml = '';
                let svgContent = '';
                const svgWidth = 350;
                const svgHeight = 200;
                const unit = 'cm';

                const base = getRandomEven(8, 20);
                const height = getRandomEven(6, 12);
                const topBase = getRandomEven(6, 12);
                const bottomBase = getRandomEven(14, 24);
                const T_height = getRandomEven(6, 12);

                switch (level) {
                    case 1: // å¹³è¡Œå››é‚Šå½¢ (åº• x é«˜)
                        correctAns = base * height;
                        questionHtml = `è«‹è¨ˆç®—ä¸‹åˆ—**å¹³è¡Œå››é‚Šå½¢**çš„é¢ç©ï¼š<br>åº• = ${base} ${unit}, é«˜ = ${height} ${unit}ã€‚`;

                        const offset = height * 5;
                        svgContent = `
                            <svg width="${svgWidth}" height="${svgHeight}" class="area-diagram">
                                <rect width="${svgWidth}" height="${svgHeight}" fill="white"/>
                                <polygon class="shape" points="${offset},${svgHeight - 20} ${svgWidth - 20},${svgHeight - 20} ${svgWidth - 20 - offset},20 20,20"/>
                                <line class="height-line" x1="${svgWidth - 20 - offset}" y1="20" x2="${svgWidth - 20 - offset}" y2="${svgHeight - 20}"/>
                                <text class="label" x="${svgWidth / 2}" y="${svgHeight - 5}" text-anchor="middle">åº•: ${base} ${unit}</text>
                                <text class="label" x="${svgWidth - offset - 40}" y="${svgHeight / 2 - 10}" fill="#ff0000">é«˜: ${height} ${unit}</text>
                            </svg>
                        `;
                        break;

                    case 2: // ä¸‰è§’å½¢ (åº• x é«˜ / 2)
                        correctAns = (base * height) / 2;
                        questionHtml = `è«‹è¨ˆç®—ä¸‹åˆ—**ä¸‰è§’å½¢**çš„é¢ç©ï¼š<br>åº• = ${base} ${unit}, é«˜ = ${height} ${unit}ã€‚`;

                        svgContent = `
                            <svg width="${svgWidth}" height="${svgHeight}" class="area-diagram">
                                <rect width="${svgWidth}" height="${svgHeight}" fill="white"/>
                                <polygon class="shape" points="20,${svgHeight - 20} ${svgWidth - 20},${svgHeight - 20} ${svgWidth / 2},20"/>
                                <line class="height-line" x1="${svgWidth / 2}" y1="20" x2="${svgWidth / 2}" y2="${svgHeight - 20}"/>
                                <text class="label" x="${svgWidth / 2}" y="${svgHeight - 5}" text-anchor="middle">åº•: ${base} ${unit}</text>
                                <text class="label" x="${svgWidth / 2 + 10}" y="${svgHeight / 2}" fill="#ff0000">é«˜: ${height} ${unit}</text>
                            </svg>
                        `;
                        break;

                    case 3: // æ¢¯å½¢ ((ä¸Šåº• + ä¸‹åº•) x é«˜ / 2)
                        correctAns = (topBase + bottomBase) * T_height / 2;
                        questionHtml = `è«‹è¨ˆç®—ä¸‹åˆ—**æ¢¯å½¢**çš„é¢ç©ï¼š<br>ä¸Šåº• = ${topBase} ${unit}, ä¸‹åº• = ${bottomBase} ${unit}, é«˜ = ${T_height} ${unit}ã€‚`;

                        const offsetT = 30;
                        svgContent = `
                            <svg width="${svgWidth}" height="${svgHeight}" class="area-diagram">
                                <rect width="${svgWidth}" height="${svgHeight}" fill="white"/>
                                <polygon class="shape" points="${offsetT},${svgHeight - 20} ${svgWidth - offsetT},${svgHeight - 20} ${svgWidth - 50},20 50,20"/>
                                <line class="height-line" x1="${svgWidth / 2}" y1="20" x2="${svgWidth / 2}" y2="${svgHeight - 20}"/>
                                <text class="label" x="${svgWidth / 2}" y="35" text-anchor="middle">ä¸Šåº•: ${topBase} ${unit}</text>
                                <text class="label" x="${svgWidth / 2}" y="${svgHeight - 5}" text-anchor="middle">ä¸‹åº•: ${bottomBase} ${unit}</text>
                                <text class="label" x="10" y="${svgHeight / 2}" fill="#ff0000">é«˜: ${T_height} ${unit}</text>
                            </svg>
                        `;
                        break;

                    case 4: // è¤‡åˆå¼é¢ç©
                        const C_TbaseA = getRandomEven(6, 10);
                        const C_TbaseB = getRandomEven(12, 20);
                        const C_THeight = getRandomEven(4, 8);
                        const C_TArea = (C_TbaseA + C_TbaseB) * C_THeight / 2;

                        const C_TriBase = C_TbaseB;
                        const C_TriHeight = getRandomEven(6, 12);
                        const C_TriArea = (C_TriBase * C_TriHeight) / 2;

                        correctAns = C_TArea + C_TriArea;
                        questionHtml = `**è«‹è¨ˆç®—ä¸‹åˆ—è¤‡åˆåœ–å½¢çš„ç¸½é¢ç©ï¼š**<br>åœ–å½¢ç”±ä¸€å€‹æ¢¯å½¢ (ä¸Š${C_TbaseA}, ä¸‹${C_TbaseB}, é«˜${C_THeight}) å’Œä¸€å€‹ä»¥æ¢¯å½¢ä¸‹åº•ç‚ºé‚Šçš„ä¸‰è§’å½¢ (é«˜${C_TriHeight}) çµ„æˆã€‚`;

                        svgContent = `
                            <svg width="${svgWidth}" height="${svgHeight}" class="area-diagram">
                                <rect width="${svgWidth}" height="${svgHeight}" fill="white"/>
                                <polygon points="100,20 ${svgWidth - 100},20 ${svgWidth - 50},80 50,80" style="fill:#FFE4B5; stroke:#000; stroke-width:2;"/>
                                <polygon points="50,80 ${svgWidth - 50},80 ${svgWidth / 2},${svgHeight - 20}" style="fill:#ADD8E6; stroke:#000; stroke-width:2;"/>
                                <line class="height-line" x1="${svgWidth / 2}" y1="20" x2="${svgWidth / 2}" y2="80"/>
                                <text class="label" x="${svgWidth / 2 + 10}" y="50" fill="#ff0000">Té«˜:${C_THeight}</text>
                                <line class="height-line" x1="${svgWidth / 2}" y1="80" x2="${svgWidth / 2}" y2="${svgHeight - 20}"/>
                                <text class="label" x="${svgWidth / 2 + 10}" y="120" fill="#ff0000">Sé«˜:${C_TriHeight}</text>
                                <text class="label" x="${svgWidth / 2}" y="15" text-anchor="middle">Tä¸Šåº•:${C_TbaseA}</text>
                                <text class="label" x="${svgWidth / 2}" y="95" text-anchor="middle">å…±ç”¨åº•:${C_TriBase}</text>
                            </svg>
                        `;
                        break;

                    default:
                        questionHtml = 'é¸æ“‡é—œå¡é–‹å§‹éŠæˆ²ã€‚';
                        break;
                }

                questionText.innerHTML = questionHtml;
                contextImage.innerHTML = svgContent;
                questionText.dataset.correctAnswer = correctAns.toFixed(0);

                questionHistory.push({
                    question: questionHtml.replace(/<br>/g, ', '),
                    correct: correctAns.toFixed(0),
                    playerAnswer: null
                });
            }

            function checkAnswer(playerAnswer) {
                if (isPaused) return;

                const roundedPlayerAnswer = Math.round(playerAnswer);
                const correctAns = parseInt(questionText.dataset.correctAnswer);
                const lastQIndex = questionHistory.length - 1;

                if (roundedPlayerAnswer === correctAns) {
                    currentCombo++;
                    timeLeft += 5;
                    const comboMultiplier = 1 + Math.min(currentCombo, 5) * 0.1;
                    const basePoints = 10;
                    const points = basePoints * comboMultiplier;
                    currentScore += Math.round(points);

                    document.getElementById('feedback-message').textContent = `âœ… ç­”å°äº†ï¼+${Math.round(points)}åˆ†, é€£æ“Š x ${comboMultiplier.toFixed(1)}ï¼Œæ™‚é–“+5ç§’ï¼`;
                    document.getElementById('feedback-message').className = 'feedback correct';

                    questionHistory[lastQIndex].playerAnswer = roundedPlayerAnswer.toString();

                } else {
                    currentCombo = 0;
                    timeLeft -= 5;

                    document.getElementById('feedback-message').textContent = `âŒ ç­”éŒ¯äº†ï¼-5ç§’ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ ${correctAns}ã€‚`;
                    document.getElementById('feedback-message').className = 'feedback incorrect';

                    questionHistory[lastQIndex].playerAnswer = roundedPlayerAnswer.toString();
                }

                scoreDisplay.textContent = `å¾—åˆ†: ${currentScore}`;
                comboDisplay.textContent = `é€£æ“Š: ${currentCombo}`;
                timerDisplay.textContent = `â³ ${timeLeft}s`;
                answerInput.value = '';

                setTimeout(() => {
                    document.getElementById('feedback-message').textContent = '';
                    if (timeLeft > 0) {
                        generateQuestion(currentLevel);
                    } else {
                        endGame();
                    }
                }, 1500);
            }

            function calculateStars(score) {
                if (score >= STAR_THRESHOLD[3]) return 3;
                if (score >= STAR_THRESHOLD[2]) return 2;
                if (score >= STAR_THRESHOLD[1]) return 1;
                return 0;
            }

            function endGame() {
                clearInterval(timerInterval);
                const finalStars = calculateStars(currentScore);
                const starSymbols = 'â˜…'.repeat(finalStars) + 'â˜†'.repeat(3 - finalStars);

                document.getElementById('final-player-name').textContent = playerName;
                document.getElementById('final-score').textContent = currentScore;
                document.getElementById('final-stars').textContent = starSymbols;
                document.getElementById('star-message').textContent = finalStars === 3 ? 'ğŸ‰ æ­å–œï¼ä¸‰é¡†æ˜Ÿå°ˆå®¶ï¼' : (finalStars > 0 ? 'è¡¨ç¾ä¸éŒ¯ï¼Œç¹¼çºŒæŒ‘æˆ°ï¼' : 'ä¸‹æ¬¡æœƒæ›´å¥½ï¼');

                const answerDisplay = document.getElementById('correct-answer-display');
                answerDisplay.innerHTML = '<h4>æœ¬å±€é¡Œç›®å›é¡§ï¼š</h4>';
                questionHistory.forEach((item, index) => {
                    const isCorrect = (item.playerAnswer === item.correct);
                    answerDisplay.innerHTML += `<p style="color: ${isCorrect ? 'green' : 'red'};">Q${index + 1}: ${item.question} | æ‚¨çš„ç­”æ¡ˆ: ${item.playerAnswer} | **æ­£ç¢ºç­”æ¡ˆ: ${item.correct}**</p>`;
                });

                updateLeaderboard(playerName, currentScore, finalStars);
                showView(resultModal);
            }

            function getLeaderboard() {
                try { return JSON.parse(localStorage.getItem('jessieMathAreaLeaderboard')) || []; } catch { return []; }
            }

            function updateLeaderboard(name, score, stars) {
                const leaderboard = getLeaderboard();
                leaderboard.push({ name, score, stars, date: new Date().toLocaleString(), level: currentLevel });
                leaderboard.sort((a, b) => b.score - a.score);
                const topTwenty = leaderboard.slice(0, 20);
                localStorage.setItem('jessieMathAreaLeaderboard', JSON.stringify(topTwenty));
                renderLeaderboard();
            }

            function renderLeaderboard() {
                const leaderboardList = document.getElementById('leaderboard-list');
                const data = getLeaderboard();
                if (!leaderboardList) return;

                leaderboardList.innerHTML = '';

                data.forEach((item, index) => {
                    const starSymbols = 'â˜…'.repeat(item.stars) + 'â˜†'.repeat(3 - item.stars);
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <span>#${index + 1} ${item.name} (L${item.level})</span>
                        <span>${starSymbols} | **${item.score}** åˆ†</span>
                    `;
                    leaderboardList.appendChild(listItem);
                });
            }

            // == äº‹ä»¶ç›£è½å™¨è¨­å®š ==

            document.getElementById('start-game-button').addEventListener('click', () => {
                playerName = playerNameInput.value.trim();

                if (playerName) {
                    showView(levelSelection);
                } else {
                    alert('è«‹è¼¸å…¥æ‚¨çš„åå­—ï¼');
                }
            });

            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                });
            });

            document.querySelectorAll('.level-card').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const level = parseInt(e.currentTarget.dataset.level);
                    if (!isNaN(level)) {
                       startGame(level);
                    }
                });
            });

            document.getElementById('show-leaderboard-btn').addEventListener('click', () => {
                renderLeaderboard();
                showView(leaderboardView);
            });

            document.getElementById('back-from-leaderboard').addEventListener('click', () => {
                showView(levelSelection);
            });

            document.getElementById('pause-button').addEventListener('click', togglePause);
            document.getElementById('resume-button').addEventListener('click', togglePause);
            document.getElementById('reset-button').addEventListener('click', () => {
                if (confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹æœ¬é—œå¡å—ï¼Ÿåˆ†æ•¸å°‡æ­¸é›¶ã€‚')) {
                    startGame(currentLevel);
                }
            });
            document.getElementById('exit-button').addEventListener('click', () => {
                if (confirm('ç¢ºå®šè¦å›é—œå¡ä¸»é¸å–®å—ï¼Ÿæœ¬æ¬¡æˆç¸¾å°‡ä¸å¯«å…¥æ’è¡Œæ¦œã€‚')) {
                    clearInterval(timerInterval);
                    questionHistory = [];
                    showView(levelSelection);
                }
            });

            submitButton.addEventListener('click', () => {
                const answer = parseFloat(answerInput.value);
                if (!isNaN(answer)) { checkAnswer(answer); } else { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—ç­”æ¡ˆï¼'); }
            });
            answerInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') { submitButton.click(); }
            });

            document.getElementById('back-to-select').addEventListener('click', () => {
                showView(levelSelection);
            });

            // åˆå§‹è¼‰å…¥ï¼šé¡¯ç¤ºèµ·å§‹é é¢
            showView(startModal);
        };
    </script>
</body>
</html>
